package emi.indo.cordova.plugin.unityads;import android.view.View;import android.view.ViewGroup;import android.widget.RelativeLayout;import com.unity3d.ads.IUnityAdsInitializationListener;import com.unity3d.ads.IUnityAdsLoadListener;import com.unity3d.ads.IUnityAdsShowListener;import com.unity3d.ads.UnityAds;import com.unity3d.ads.metadata.MetaData;import com.unity3d.services.banners.BannerErrorInfo;import com.unity3d.services.banners.BannerView;import com.unity3d.services.banners.UnityBannerSize;import org.apache.cordova.CallbackContext;import org.apache.cordova.CordovaInterface;import org.apache.cordova.CordovaPlugin;import org.apache.cordova.CordovaWebView;import org.json.JSONArray;import org.json.JSONException;import org.json.JSONObject;import java.util.Objects;public class emiUnityAdsPlugin extends CordovaPlugin{private static final String TAG="emiUnityAdsPlugin";private CallbackContext PUBLIC_CALLBACKS=null;Boolean Debug=false;private CordovaWebView cWebView;private RelativeLayout bannerViewLayout;private BannerView bannerView;static boolean isBannerShow=false;static boolean isBannerLoad=false;String bannerPlacementId=null;String Position=null;String interstitialPlacementId=null;static boolean isInterstitialLoad=false;String videoPlacementId=null;static boolean isVideoLoad=false;public void initialize(CordovaInterface cordova,CordovaWebView webView){super.initialize(cordova,webView);cWebView=webView;}public boolean execute(String action,JSONArray args,final CallbackContext callbackContext)throws JSONException{PUBLIC_CALLBACKS=callbackContext;if(action.equals("unitySdkInitialize")){cordova.getActivity().runOnUiThread(()->{final String unityGameID=args.optString(0);UnityAds.initialize(cordova.getActivity(),unityGameID,new IUnityAdsInitializationListener(){@Override public void onInitializationComplete(){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onInitializationComplete');");}@Override public void onInitializationFailed(UnityAds.UnityAdsInitializationError error,String message){callbackContext.error(error.toString());cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onInitializationFailed');");}});});return true;}if(action.equals("setPrivacyAndConsent")){final boolean consent=args.optBoolean(0);final boolean privacy=args.optBoolean(1);final boolean useroveragelimit=args.optBoolean(2);cordova.getActivity().runOnUiThread(()->{MetaData gdprMetaData=new MetaData(cordova.getContext());gdprMetaData.set("gdpr.consent",consent);gdprMetaData.commit();MetaData privacyMetaData=new MetaData(cordova.getContext());privacyMetaData.set("privacy.consent",privacy);privacyMetaData.commit();MetaData ageGateMetaData=new MetaData(cordova.getContext());ageGateMetaData.set("privacy.useroveragelimit",useroveragelimit);ageGateMetaData.commit();});return true;}if(action.equals("debugLoadAdError")){final boolean debug=args.optBoolean(0);cordova.getActivity().runOnUiThread(()->{this.Debug=debug;});return true;}if(action.equals("loadBannerAd")){final String placementId=args.optString(0);final String position=args.optString(1);cordova.getActivity().runOnUiThread(()->{this.bannerPlacementId=placementId;this.Position=position;_loadBannerAd(callbackContext);});return true;}if(action.equals("showBannerAd")){if(isBannerLoad){cordova.getActivity().runOnUiThread(()->{bannerViewLayout.addView(bannerView);isBannerLoad=false;});}return true;}if(action.equals("hideBannerAd")){cordova.getActivity().runOnUiThread(()->{if(isBannerShow){bannerView.destroy();bannerView=null;isBannerShow=false;}});return true;}if(action.equals("loadInterstitialAd")){final String placementId=args.getString(0);cordova.getActivity().runOnUiThread(()->{this.interstitialPlacementId=placementId;_loadInterstitialAd(callbackContext);});return true;}if(action.equals("showInterstitialAd")){cordova.getActivity().runOnUiThread(()->{if(isInterstitialLoad){_showInterstitialAd(callbackContext);}});return true;}if(action.equals("loadVideoAd")){final String placementId=args.getString(0);cordova.getActivity().runOnUiThread(()->{this.videoPlacementId=placementId;_loadVideoAd(callbackContext);});return true;}if(action.equals("showVideoAd")){if(isVideoLoad){cordova.getActivity().runOnUiThread(()->{_showVideoAd(callbackContext);});}return true;}return false;}private void _loadBannerAd(CallbackContext callbackContext){if(bannerPlacementId==null||bannerPlacementId.equals("")){callbackContext.error("placementId=null");}if(bannerViewLayout==null){bannerView=null;bannerViewLayout=new RelativeLayout(cordova.getActivity());RelativeLayout.LayoutParams params=new RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.MATCH_PARENT,RelativeLayout.LayoutParams.MATCH_PARENT);bannerViewLayout.setLayoutParams(params);((ViewGroup)Objects.requireNonNull(getWebView())).addView(bannerViewLayout);}if(bannerView==null){if(bannerPlacementId!=null){bannerView=new BannerView(cordova.getActivity(),this.bannerPlacementId,new UnityBannerSize(320,50));bannerView.setListener(bannerListener);}RelativeLayout.LayoutParams params=new RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.MATCH_PARENT,RelativeLayout.LayoutParams.WRAP_CONTENT);switch(Position){case "top-left":params.addRule(RelativeLayout.ALIGN_PARENT_TOP);params.addRule(RelativeLayout.ALIGN_PARENT_LEFT);break;case "top-center":params.addRule(RelativeLayout.ALIGN_PARENT_TOP);params.addRule(RelativeLayout.CENTER_HORIZONTAL);break;case "top-right":params.addRule(RelativeLayout.ALIGN_PARENT_TOP);params.addRule(RelativeLayout.ALIGN_PARENT_RIGHT);break;case "left":params.addRule(RelativeLayout.ALIGN_PARENT_LEFT);params.addRule(RelativeLayout.CENTER_VERTICAL);break;case "center":params.addRule(RelativeLayout.CENTER_HORIZONTAL);params.addRule(RelativeLayout.CENTER_VERTICAL);break;case "right":params.addRule(RelativeLayout.ALIGN_PARENT_RIGHT);params.addRule(RelativeLayout.CENTER_VERTICAL);break;case "bottom-left":params.addRule(RelativeLayout.ALIGN_PARENT_BOTTOM);params.addRule(RelativeLayout.ALIGN_PARENT_LEFT);break;case "bottom-center":params.addRule(RelativeLayout.ALIGN_PARENT_BOTTOM);params.addRule(RelativeLayout.CENTER_HORIZONTAL);break;default:params.addRule(RelativeLayout.ALIGN_PARENT_BOTTOM);params.addRule(RelativeLayout.ALIGN_PARENT_RIGHT);break;}bannerView.setLayoutParams(params);bannerView.load();}}private View getWebView(){try{return(View)webView.getClass().getMethod("getView").invoke(webView);}catch(Exception e){return(View)webView;}}private final BannerView.IListener bannerListener=new BannerView.IListener(){@Override public void onBannerLoaded(BannerView bannerAdView){isBannerShow=true;isBannerLoad=true;cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onBannerLoaded');");}@Override public void onBannerFailedToLoad(BannerView bannerAdView,BannerErrorInfo errorInfo){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onBannerFailedToLoad');");if(Debug){JSONObject result=new JSONObject();try{result.put("errorMessage",errorInfo.errorMessage);result.put("errorCode",errorInfo.errorCode);PUBLIC_CALLBACKS.success(result);}catch(JSONException e){PUBLIC_CALLBACKS.error(e.getMessage());}}}@Override public void onBannerClick(BannerView bannerAdView){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onBannerClick');");}@Override public void onBannerLeftApplication(BannerView bannerAdView){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onBannerLeftApplication');");}};private void _loadInterstitialAd(CallbackContext callbackContext){IUnityAdsLoadListener loadListener=new IUnityAdsLoadListener(){@Override public void onUnityAdsAdLoaded(String placementId){isInterstitialLoad=true;cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsAdLoaded.Interstitial');");}@Override public void onUnityAdsFailedToLoad(String placementId,UnityAds.UnityAdsLoadError error,String message){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsFailedToLoad.Interstitial');");if(Debug){JSONObject result=new JSONObject();try{result.put("errorInfo",error);result.put("message",message);callbackContext.success(result);}catch(JSONException e){callbackContext.error(e.getMessage());}}}};UnityAds.load(this.interstitialPlacementId,loadListener);}private void _showInterstitialAd(CallbackContext callbackContext){IUnityAdsShowListener showListener=new IUnityAdsShowListener(){@Override public void onUnityAdsShowFailure(String placementId,UnityAds.UnityAdsShowError error,String message){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsShowFailure.Interstitial');");}@Override public void onUnityAdsShowStart(String placementId){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsShowStart.Interstitial');");}@Override public void onUnityAdsShowClick(String placementId){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsShowClick.Interstitial');");}@Override public void onUnityAdsShowComplete(String placementId,UnityAds.UnityAdsShowCompletionState state){isInterstitialLoad=false;if(state.equals(UnityAds.UnityAdsShowCompletionState.COMPLETED)){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsShowComplete.Interstitial');");}else if(state.equals(UnityAds.UnityAdsShowCompletionState.SKIPPED)){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsShowSkipped.Interstitial');");}}};UnityAds.show(cordova.getActivity(),this.interstitialPlacementId,showListener);}private void _loadVideoAd(CallbackContext callbackContext){UnityAds.load(this.videoPlacementId,new IUnityAdsLoadListener(){@Override public void onUnityAdsAdLoaded(String placementId){isVideoLoad=true;cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsAdLoaded.video');");}@Override public void onUnityAdsFailedToLoad(String placementId,UnityAds.UnityAdsLoadError error,String message){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsFailedToLoad.video');");if(Debug){JSONObject result=new JSONObject();try{result.put("errorInfo",error);result.put("message",message);callbackContext.success(result);}catch(JSONException e){callbackContext.error(e.getMessage());}}}});}private void _showVideoAd(CallbackContext callbackContext){UnityAds.show(cordova.getActivity(),this.videoPlacementId,new IUnityAdsShowListener(){@Override public void onUnityAdsShowFailure(String placementId,UnityAds.UnityAdsShowError error,String message){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsShowFailure.video');");}@Override public void onUnityAdsShowStart(String placementId){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsShowStart.video');");}@Override public void onUnityAdsShowClick(String placementId){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsShowClick.video');");}@Override public void onUnityAdsShowComplete(String placementId,UnityAds.UnityAdsShowCompletionState state){isVideoLoad=false;if(state.equals(UnityAds.UnityAdsShowCompletionState.COMPLETED)){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsShowComplete.video');");}else if(state.equals(UnityAds.UnityAdsShowCompletionState.SKIPPED)){cWebView.loadUrl("javascript:cordova.fireDocumentEvent('onUnityAdsShowSkipped.video');");}}});}@Override public void onDestroy(){if(bannerView!=null){bannerView.destroy();bannerView=null;}if(bannerViewLayout!=null){ViewGroup parentView=(ViewGroup)bannerViewLayout.getParent();if(parentView!=null){parentView.removeView(bannerViewLayout);}bannerViewLayout=null;}super.onDestroy();}}